<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Track Finder Debug Tool</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1 {
      color: #333;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"] {
      padding: 8px;
      width: 100%;
      max-width: 500px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background-color: #45a049;
    }
    .results {
      margin-top: 20px;
      padding: 15px;
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    pre {
      background-color: #f8f8f8;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .audio-player {
      margin-top: 20px;
    }
    .success {
      color: green;
      font-weight: bold;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Track Finder Debug Tool</h1>
  
  <div class="input-group">
    <label for="trackNameInput">Track Name:</label>
    <input type="text" id="trackNameInput" placeholder="Enter track name (e.g. 'unknown track')">
  </div>
  
  <div class="input-group">
    <label for="assetTypeSelect">Asset Type:</label>
    <select id="assetTypeSelect">
      <option value="main.mp3">Main Audio (main.mp3)</option>
      <option value="cover.jpg">Cover Image (cover.jpg)</option>
    </select>
  </div>
  
  <button id="testDirectS3Button">Test Direct S3 API</button>
  <button id="listTracksButton">List Available Tracks</button>
  
  <div class="results" id="resultsContainer">
    <h2>Results:</h2>
    <div id="resultsOutput">Enter a track name and click a button to test.</div>
  </div>
  
  <div class="audio-player" id="audioPlayerContainer" style="display: none;">
    <h2>Audio Player:</h2>
    <audio id="audioPlayer" controls></audio>
  </div>
  
  <div class="image-preview" id="imagePreviewContainer" style="display: none;">
    <h2>Image Preview:</h2>
    <img id="imagePreview" style="max-width: 300px; max-height: 300px;">
  </div>

  <script>
    // DOM Elements
    const trackNameInput = document.getElementById('trackNameInput');
    const assetTypeSelect = document.getElementById('assetTypeSelect');
    const testDirectS3Button = document.getElementById('testDirectS3Button');
    const listTracksButton = document.getElementById('listTracksButton');
    const resultsOutput = document.getElementById('resultsOutput');
    const audioPlayerContainer = document.getElementById('audioPlayerContainer');
    const audioPlayer = document.getElementById('audioPlayer');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');
    
    // Event Listeners
    testDirectS3Button.addEventListener('click', testDirectS3);
    listTracksButton.addEventListener('click', listTracks);
    
    // Format JSON with spacing
    function formatJSON(obj) {
      return JSON.stringify(obj, null, 2);
    }
    
    // Display results with formatting
    function displayResults(message, data = null, isError = false) {
      let output = `<p class="${isError ? 'error' : 'success'}">${message}</p>`;
      
      if (data) {
        output += `<pre>${typeof data === 'string' ? data : formatJSON(data)}</pre>`;
      }
      
      resultsOutput.innerHTML = output;
    }
    
    // Test Direct S3 API
    async function testDirectS3() {
      const trackName = trackNameInput.value.trim();
      const assetType = assetTypeSelect.value;
      
      if (!trackName) {
        displayResults('Please enter a track name', null, true);
        return;
      }
      
      // Hide previous media players
      audioPlayerContainer.style.display = 'none';
      imagePreviewContainer.style.display = 'none';
      
      try {
        displayResults('Testing direct S3 API...');
        
        // Convert track name to URL-friendly format
        const sanitizedTrackName = trackName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
        const url = `/api/direct-s3/tracks/${sanitizedTrackName}/${assetType}`;
        
        displayResults(`Fetching: ${url}`);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error ${response.status}: ${errorText}`);
        }
        
        // Handle audio
        if (assetType.endsWith('.mp3')) {
          // Create object URL for the audio blob
          const blob = await response.blob();
          const objectUrl = URL.createObjectURL(blob);
          
          // Update the audio player
          audioPlayer.src = objectUrl;
          audioPlayerContainer.style.display = 'block';
          
          displayResults(`Successfully loaded audio from: ${url}`, {
            contentType: response.headers.get('Content-Type'),
            contentLength: response.headers.get('Content-Length'),
            url: url
          });
        } 
        // Handle image
        else if (assetType.endsWith('.jpg')) {
          // Create object URL for the image blob
          const blob = await response.blob();
          const objectUrl = URL.createObjectURL(blob);
          
          // Update the image preview
          imagePreview.src = objectUrl;
          imagePreviewContainer.style.display = 'block';
          
          displayResults(`Successfully loaded image from: ${url}`, {
            contentType: response.headers.get('Content-Type'),
            contentLength: response.headers.get('Content-Length'),
            url: url
          });
        }
      } catch (error) {
        displayResults(`Error: ${error.message}`, null, true);
      }
    }
    
    // List Available Tracks
    async function listTracks() {
      try {
        displayResults('Fetching available tracks...');
        
        const response = await fetch('/api/s3-list-tracks');
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          displayResults(
            `Found ${data.tracks.length} tracks in the S3 bucket`, 
            data.tracks.map(track => ({
              path: track.path,
              name: track.name
            }))
          );
        } else {
          throw new Error(data.error?.message || 'Unknown error');
        }
      } catch (error) {
        displayResults(`Error listing tracks: ${error.message}`, null, true);
      }
    }
  </script>
</body>
</html> 